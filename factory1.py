import streamlit as st
import folium
from streamlit_folium import st_folium
import math

# -----------------------
# ê³µì¥ ë°ì´í„° ì •ì˜
factory_data = [
    ("ì²œë³´ì‚°ì—…(ì£¼)", 37.3854307660555, 126.744708042195),
    ("ì²œì§€í™˜ê²½(ì£¼)", 35.111834614236, 126.489085979136),
    ("íƒœí˜•ê¸°ì—…(ì£¼) ì–‘ì£¼ì‚¬ì—…ì†Œ", 37.8648422910068, 126.994044440869),
    ("í•œë°­ì‚°ì—…(ì£¼)", 37.4874943034288, 126.670372732237),
    ("í•œì„±ì•„ìŠ¤ì½˜(ì£¼)ê²½ì‚°ê³µì¥", 35.8609951390608, 128.804213107994),
    ("í˜¸ë‚¨ì‚°ì—…(ì£¼)", 34.9910417435609, 127.527267556238),
    ("ëŒ€í•œì´ì•¤ì´(ì£¼)", 35.9452467987393, 126.620827343196),
    ("ì‚¼ì‚¼í™˜ê²½(ì£¼)", 35.2574023420021, 128.152216448851),
    ("ìƒë¡í™˜ê²½(ì£¼)", 36.1646161269317, 128.266637687781),
    ("ì„¸ì•„ì‚°ì—…(ì£¼)", 36.0469233095266, 128.348351465668),
    ("ìš°ì§„í™˜ê²½ê°œë°œ(ì£¼)", 36.7582028058524, 127.558654803372),
    ("ì´ë„ì—ì½”ì œì£¼(ì£¼)", 33.3685823655302, 126.279199318977),
    ("ì¸ì„ ê¸°ì—…(ì£¼)", 36.1721683726224, 127.399651548619),
    ("ì¸ì›ì‚°ì—…(ì£¼)", 35.2828114317709, 126.975220440774),
    ("ì •ë¦¼ì´ì•¤í‹°(ì£¼)", 35.9478760514642, 126.600107125834),
    ("ì£¼ëª©ì‚°ì—…(ì£¼)", 35.4501426030705, 129.286641278202),
    ("(í•©)ê°•ì›í™˜ê²½", 37.6621512516454, 127.879980818075),
    ("(í•©)ìš°ì°½í™˜ê²½ì‚°ì—…", 37.3529093634444, 127.880588830474),
    ("(í•©)í™ì²œí™˜ê²½ì‚°ì—…", 37.6621512516454, 127.879980818075),
    ("ê²½ì›(ì£¼)", 35.7206113714419, 129.277709341322),
    ("ê·¸ë¦°ìŠ¤í†¤ì‚°ì—…(ì£¼)", 37.8654000829756, 127.038680456968),
    ("ë‚¨ì¼í™˜ê²½ì‚°ì—…", 35.0922178230359, 129.070460701891),
    ("ëŒ€êµí™˜ê²½(ì£¼)", 37.0230454933199, 128.351593897366),
    ("ëŒ€ëª…ì¢…í•©í™˜ê²½ì‚°ì—…(ì£¼)", 36.7488197063065, 126.499100670723),
    ("ëŒ€ë¶€ê°œë°œ(ì£¼)", 35.2619846186897, 128.511996745941),
    ("ëŒ€ì§„í™˜ê²½ì‚°ì—…", 37.1798601533987, 128.245549065528),
    ("(ì£¼)ìš°ì„±ì‚°ì—…ê°œë°œ", 36.9917422067957, 126.835012015176),
    ("(ì£¼)ì›ì£¼ì—”ì§€ë‹ˆì–´ë§", 37.3792584234367, 127.934454913401),
    ("(ì£¼)ìœ¤ì„±ì‚°ì—…ê°œë°œ", 35.9038062146943, 128.415887684815),
    ("(ì£¼)ìœ¤ì›í™˜ê²½", 37.4162613870717, 128.420397859125),
    ("(ì£¼)ì´ë„", 37.5818578641763, 126.65532177558),
    ("(ì£¼)ì´í™”ì‚°ì—…", 37.6082629675804, 128.46636792285),
    ("(ì£¼)íƒœì‚°íŒŒìš°í…", 35.7914346035399, 128.390455223712),
    ("(ì£¼)í•œì†”ê±´ì„¤ì‚°ì—…", 36.78356577716, 126.914179545037),
    ("(ì£¼)í•œì†”ì‚°ì—…ê°œë°œ", 37.3755285292934, 126.742544417505),
    ("(ì£¼)í™ëª…ì‚°ì—…", 37.7549239300561, 126.87185269087),
    ("(ì)ê¸ˆê°•ê°œë°œ", 37.3514544005819, 127.88174154518),
    ("(ì£¼)í•œì†”ì‚°ì—…ê°œë°œ", 37.3755285292934, 126.742544417505),
    ("ëŒ€êµí™˜ê²½(ì£¼)", 37.0230454933199, 128.351593897366),
    # í•„ìš”í•œ ë§Œí¼ ì¶”ê°€...
]

# -----------------------
# ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹)
def haversine(lat1, lon1, lat2, lon2):
    R = 6371  # ì§€êµ¬ ë°˜ì§€ë¦„ (km)
    phi1, phi2 = math.radians(lat1), math.radians(lat2)
    dphi = math.radians(lat2 - lat1)
    dlambda = math.radians(lon2 - lon1)
    a = math.sin(dphi/2)**2 + math.cos(phi1) * math.cos(phi2) * math.sin(dlambda/2)**2
    return 2 * R * math.asin(math.sqrt(a))

# ê°€ì¥ ê°€ê¹Œìš´ ê³µì¥ ì°¾ê¸°
def find_nearest_factory(click_lat, click_lon):
    min_dist = float('inf')
    nearest_factory = None
    for name, lat, lon in factory_data:
        dist = haversine(click_lat, click_lon, lat, lon)
        if dist < min_dist:
            min_dist = dist
            nearest_factory = (name, dist)
    return nearest_factory

# -----------------------
# Streamlit ì•± ì‹œì‘
st.set_page_config(layout="wide")
st.title("ğŸ“ ê³µì¥ ìœ„ì¹˜ ì§€ë„ (ì‹¤ì‹œê°„ ìƒí˜¸ì‘ìš©)")

# í´ë¦­ ê¸°ë¡ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "click_history" not in st.session_state:
    st.session_state.click_history = []

# ì§€ë„ ê°ì²´ ìƒì„±
m = folium.Map(location=[36.5, 127.5], zoom_start=7)

# ê¸°ì¡´ ê³µì¥ ë§ˆì»¤ ì¶”ê°€ (íŒŒë€ìƒ‰ ë§ˆì»¤)
for name, lat, lon in factory_data:
    folium.Marker(
        location=[lat, lon],
        popup=name,
        icon=folium.Icon(color="blue", icon="industry", prefix="fa")
    ).add_to(m)

# í´ë¦­ ê¸°ë¡ìœ¼ë¡œ ë¹¨ê°„ ë§ˆì»¤ ì¶”ê°€
for record in st.session_state.click_history:
    folium.Marker(
        location=[record["ìœ„ë„"], record["ê²½ë„"]],
        popup=f"ğŸ“ í´ë¦­í•œ ìœ„ì¹˜<br>ğŸ“¦ ê°€ì¥ ê°€ê¹Œìš´ ê³µì¥: {record['ê°€ì¥ ê°€ê¹Œìš´ ê³µì¥']}<br>ğŸ“ ê±°ë¦¬: {record['ê±°ë¦¬ (km)']:.2f} km",
        icon=folium.Icon(color="red", icon="map-marker", prefix="fa")
    ).add_to(m)

# ì§€ë„ ë Œë”ë§ (í•œ ë²ˆë§Œ)
map_data = st_folium(m, width=1400, height=800)

# í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
if map_data and map_data.get("last_clicked"):
    clicked = map_data["last_clicked"]
    lat, lon = round(clicked["lat"], 4), round(clicked["lng"], 4)

    # ì¤‘ë³µ í´ë¦­ ë°©ì§€
    if not any(rec["ìœ„ë„"] == lat and rec["ê²½ë„"] == lon for rec in st.session_state.click_history):
        nearest_factory, distance = find_nearest_factory(lat, lon)
        st.session_state.click_history.append({
            "ìœ„ë„": lat,
            "ê²½ë„": lon,
            "ê°€ì¥ ê°€ê¹Œìš´ ê³µì¥": nearest_factory,
            "ê±°ë¦¬ (km)": round(distance, 2)
        })
        # ìƒˆ ë§ˆì»¤ ë°˜ì˜ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
        st.rerun()

# í´ë¦­ ê¸°ë¡ ì¶œë ¥
st.subheader("ğŸ“œ í´ë¦­ ê¸°ë¡")
if st.session_state.click_history:
    st.table(st.session_state.click_history)
else:
    st.info("ğŸ–±ï¸ ì§€ë„ë¥¼ í´ë¦­í•´ ë³´ì„¸ìš”!")

# í´ë¦­ ê¸°ë¡ ì´ˆê¸°í™” ë²„íŠ¼
if st.button("ğŸ“‚ í´ë¦­ ê¸°ë¡ ì´ˆê¸°í™”"):
    st.session_state.click_history = []
    st.rerun()
